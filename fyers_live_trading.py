#!/usr/bin/env python3
"""
FYERS LIVE TRADING INTEGRATION
Real money automated trading with FYERS API

ðŸš€ FEATURES:
- Live FYERS API integration
- Real money order execution
- Position management
- Account monitoring
- Risk controls for live trading
"""

import json
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
import pandas as pd
import numpy as np

try:
    from fyers_apiv3 import fyersModel
    FYERS_AVAILABLE = True
except ImportError:
    FYERS_AVAILABLE = False
    
class FyersLiveTrader:
    """
    FYERS Live Trading Integration for Real Money Trading
    """
    
    def __init__(self, config_file: str = "fyers_config.json"):
        # Load FYERS configuration
        self.config = self._load_fyers_config(config_file)
        
        # Initialize FYERS API
        self.fyers = None
        self._initialize_fyers_api()
        
        # Trading state
        self.account_info = {}
        self.positions = {}
        self.orders = {}
        
        # Setup logging
        self._setup_logging()
        
        self.logger.info("ðŸš€ FYERS Live Trader Initialized")
        
    def _load_fyers_config(self, config_file: str) -> Dict:
        """Load FYERS trading configuration"""
        
        default_config = {
            "fyers": {
                "client_id": "",  # Your FYERS Client ID (e.g., "XYZ1234-100")
                "access_token": "",  # Your FYERS Access Token
                "redirect_uri": "https://trade.fyers.in/api-login/redirect-to-app",
                "response_type": "code",
                "state": "sample_state"
            },
            "trading": {
                "live_trading": False,  # Set to True for live trading with real money
                "max_orders_per_minute": 10,
                "order_timeout": 300,
                "slippage_tolerance": 0.5,  # 0.5% slippage tolerance
                "max_position_size": 50000,  # Max position size in INR
                "risk_per_trade": 0.02  # 2% risk per trade
            },
            "symbols": {
                "NSE:NIFTY50-INDEX": "NSE:NIFTY2470724700CE",  # Example option symbol
                "NSE:NIFTYBANK-INDEX": "NSE:BANKNIFTY2470751500CE",
                "NSE:RELIANCE-EQ": "NSE:RELIANCE-EQ",
                "NSE:TCS-EQ": "NSE:TCS-EQ",
                "NSE:INFY-EQ": "NSE:INFY-EQ"
            }
        }
        
        try:
            with open(config_file, 'r') as f:
                loaded_config = json.load(f)
                # Update default with loaded config
                default_config.update(loaded_config)
        except FileNotFoundError:
            # Create default config file
            with open(config_file, 'w') as f:
                json.dump(default_config, f, indent=2)
            print(f"ðŸ“ Created FYERS config file: {config_file}")
            print("âš ï¸ Please update with your FYERS API credentials before live trading!")
            
        return default_config\n        \n    def _setup_logging(self):\n        \"\"\"Setup logging for FYERS trading\"\"\"\n        \n        logging.basicConfig(\n            level=logging.INFO,\n            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n            handlers=[\n                logging.FileHandler('fyers_live_trading.log'),\n                logging.StreamHandler()\n            ]\n        )\n        self.logger = logging.getLogger('FYERS_LIVE_TRADER')\n        \n    def _initialize_fyers_api(self):\n        \"\"\"Initialize FYERS API for live trading\"\"\"\n        \n        if not FYERS_AVAILABLE:\n            self.logger.error(\"âŒ FYERS API not installed. Run: pip install fyers-apiv3\")\n            return False\n            \n        fyers_config = self.config['fyers']\n        \n        if not fyers_config['client_id'] or not fyers_config['access_token']:\n            self.logger.warning(\"âš ï¸ FYERS credentials not configured\")\n            self.logger.warning(\"ðŸ“ Update fyers_config.json with your API credentials\")\n            return False\n            \n        try:\n            # Initialize FYERS API for LIVE TRADING\n            self.fyers = fyersModel.FyersModel(\n                client_id=fyers_config['client_id'],\n                token=fyers_config['access_token'],\n                log_path=\"fyers_api.log\"\n            )\n            \n            # Test API connection with real account\n            profile_response = self.fyers.get_profile()\n            \n            if profile_response and profile_response.get('s') == 'ok':\n                profile_data = profile_response['data']\n                \n                self.logger.info(\"ðŸš€ FYERS API CONNECTED - LIVE TRADING ENABLED\")\n                self.logger.info(f\"ðŸ‘¤ Account: {profile_data.get('name', 'N/A')}\")\n                self.logger.info(f\"ðŸ“§ Email: {profile_data.get('email', 'N/A')}\")\n                self.logger.info(f\"ðŸ¦ Broker: FYERS\")\n                \n                # Store account info\n                self.account_info = profile_data\n                \n                # Get account balance for real money trading\n                self._get_account_balance()\n                \n                return True\n                \n            else:\n                self.logger.error(f\"âŒ FYERS API Connection Failed: {profile_response}\")\n                return False\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ FYERS API initialization failed: {e}\")\n            self.logger.error(\"ðŸ’¡ Check your client_id and access_token in fyers_config.json\")\n            return False\n            \n    def _get_account_balance(self):\n        \"\"\"Get real account balance from FYERS\"\"\"\n        \n        if not self.fyers:\n            return None\n            \n        try:\n            funds_response = self.fyers.funds()\n            \n            if funds_response and funds_response.get('s') == 'ok':\n                fund_data = funds_response['data']['fund_limit'][0]\n                \n                available_balance = fund_data.get('equityAmount', 0)\n                utilized_amount = fund_data.get('utilized_amount', 0)\n                total_balance = available_balance + utilized_amount\n                \n                self.logger.info(\"ðŸ’° LIVE ACCOUNT BALANCE:\")\n                self.logger.info(f\"   ðŸ’µ Available: â‚¹{available_balance:,.2f}\")\n                self.logger.info(f\"   ðŸ“Š Utilized: â‚¹{utilized_amount:,.2f}\")\n                self.logger.info(f\"   ðŸ¦ Total: â‚¹{total_balance:,.2f}\")\n                \n                return {\n                    'available_balance': available_balance,\n                    'utilized_amount': utilized_amount,\n                    'total_balance': total_balance\n                }\n                \n            else:\n                self.logger.error(f\"âŒ Failed to get account balance: {funds_response}\")\n                return None\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error getting account balance: {e}\")\n            return None\n            \n    def get_live_market_data(self, symbol: str, timeframe: str = \"1\", days: int = 30) -> pd.DataFrame:\n        \"\"\"Get LIVE market data from FYERS for real trading\"\"\"\n        \n        if not self.fyers:\n            self.logger.error(\"âŒ FYERS API not initialized\")\n            return pd.DataFrame()\n            \n        try:\n            # Convert timeframe for FYERS\n            fyers_resolution = self._convert_timeframe(timeframe)\n            \n            # Calculate date range\n            end_date = datetime.now()\n            start_date = end_date - timedelta(days=days)\n            \n            # Prepare FYERS API request for LIVE DATA\n            data_request = {\n                \"symbol\": symbol,\n                \"resolution\": fyers_resolution,\n                \"date_format\": \"1\",\n                \"range_from\": start_date.strftime(\"%Y-%m-%d\"),\n                \"range_to\": end_date.strftime(\"%Y-%m-%d\"),\n                \"cont_flag\": \"1\"\n            }\n            \n            response = self.fyers.history(data_request)\n            \n            if response and response.get('s') == 'ok' and 'candles' in response:\n                candles = response['candles']\n                \n                if candles:\n                    df = pd.DataFrame(\n                        candles,\n                        columns=['timestamp', 'open', 'high', 'low', 'close', 'volume']\n                    )\n                    \n                    df['timestamp'] = pd.to_datetime(df['timestamp'], unit='s')\n                    df.set_index('timestamp', inplace=True)\n                    \n                    self.logger.info(f\"ðŸ“ˆ LIVE Data: {len(df)} candles for {symbol}\")\n                    return df\n                    \n            self.logger.warning(f\"âš ï¸ No data received for {symbol}: {response}\")\n            return pd.DataFrame()\n            \n        except Exception as e:\n            self.logger.error(f\"âŒ Error getting live data for {symbol}: {e}\")\n            return pd.DataFrame()\n            \n    def _convert_timeframe(self, timeframe: str) -> str:\n        \"\"\"Convert timeframe to FYERS format\"\"\"\n        \n        mapping = {\n            \"1\": \"1\",      # 1 minute\n            \"5\": \"5\",      # 5 minutes  \n            \"15\": \"15\",    # 15 minutes\n            \"30\": \"30\",    # 30 minutes\n            \"60\": \"60\",    # 1 hour\n            \"D\": \"1D\"      # 1 day\n        }\n        \n        return mapping.get(timeframe, \"1\")\n        \n    def place_live_order(self, symbol: str, side: str, quantity: int, order_type: str = \"MARKET\", price: float = None) -> Dict:\n        \"\"\"Place LIVE order with REAL MONEY through FYERS API\"\"\"\n        \n        if not self.fyers:\n            return {\"status\": \"error\", \"message\": \"FYERS API not initialized\"}\n            \n        if not self.config['trading']['live_trading']:\n            self.logger.warning(\"âš ï¸ Live trading disabled in config - set live_trading: true\")\n            return {\"status\": \"error\", \"message\": \"Live trading disabled in configuration\"}\n            \n        try:\n            # Prepare order for REAL MONEY TRADING\n            order_data = {\n                \"symbol\": symbol,\n                \"qty\": quantity,\n                \"type\": 1 if side.upper() == \"BUY\" else -1,  # 1 for BUY, -1 for SELL\n                \"side\": 1,  # 1 for entry, -1 for exit\n                \"productType\": \"CNC\",  # Cash and Carry\n                \"limitPrice\": price if order_type == \"LIMIT\" else 0,\n                \"stopPrice\": 0,\n                \"validity\": \"DAY\",\n                \"disclosedQty\": 0,\n                \"offlineOrder\": \"False\"\n            }\n            \n            self.logger.info(f\"ðŸš€ PLACING LIVE ORDER WITH REAL MONEY:\")\n            self.logger.info(f\"   ðŸ“Š Symbol: {symbol}\")\n            self.logger.info(f\"   ðŸ’° Side: {side}\")\n            self.logger.info(f\"   ðŸ“¦ Quantity: {quantity}\")\n            self.logger.info(f\"   ðŸ·ï¸ Type: {order_type}\")\n            if price:\n                self.logger.info(f\"   ðŸ’µ Price: â‚¹{price:.2f}\")\n                \n            # Execute LIVE ORDER\n            response = self.fyers.place_order(order_data)\n            \n            if response and response.get('s') == 'ok':\n                order_id = response.get('id')\n                \n                self.logger.info(f\"âœ… LIVE ORDER PLACED SUCCESSFULLY!\")\n                self.logger.info(f\"   ðŸ†” Order ID: {order_id}\")\n                \n                # Store order information\n                self.orders[order_id] = {\n                    'symbol': symbol,\n                    'side': side,\n                    'quantity': quantity,\n                    'order_type': order_type,\n                    'price': price,\n                    'timestamp': datetime.now(),\n                    'status': 'PLACED'\n                }\n                \n                return {\n                    \"status\": \"success\",\n                    \"order_id\": order_id,\n                    \"message\": \"Live order placed successfully\"\n                }\n                \n            else:\n                self.logger.error(f\"âŒ ORDER PLACEMENT FAILED: {response}\")\n                return {\n                    \"status\": \"error\",\n                    \"message\": f\"Order placement failed: {response}\"\n                }\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error placing live order: {e}\")\n            return {\n                \"status\": \"error\",\n                \"message\": f\"Order placement error: {str(e)}\"\n            }\n            \n    def get_live_positions(self) -> Dict:\n        \"\"\"Get LIVE positions from FYERS account\"\"\"\n        \n        if not self.fyers:\n            return {}\n            \n        try:\n            response = self.fyers.positions()\n            \n            if response and response.get('s') == 'ok':\n                positions_data = response.get('netPositions', [])\n                \n                live_positions = {}\n                \n                for position in positions_data:\n                    symbol = position.get('symbol', '')\n                    quantity = position.get('qty', 0)\n                    \n                    if quantity != 0:  # Only active positions\n                        live_positions[symbol] = {\n                            'symbol': symbol,\n                            'quantity': quantity,\n                            'avg_price': position.get('avgPrice', 0),\n                            'current_price': position.get('ltp', 0),\n                            'pnl': position.get('realized_profit', 0) + position.get('unrealized_profit', 0),\n                            'unrealized_pnl': position.get('unrealized_profit', 0),\n                            'realized_pnl': position.get('realized_profit', 0)\n                        }\n                        \n                self.logger.info(f\"ðŸ“Š LIVE Positions: {len(live_positions)} active\")\n                \n                # Update stored positions\n                self.positions = live_positions\n                \n                return live_positions\n                \n            else:\n                self.logger.error(f\"âŒ Failed to get positions: {response}\")\n                return {}\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error getting live positions: {e}\")\n            return {}\n            \n    def get_order_status(self, order_id: str) -> Dict:\n        \"\"\"Get LIVE order status from FYERS\"\"\"\n        \n        if not self.fyers:\n            return {}\n            \n        try:\n            response = self.fyers.orderbook()\n            \n            if response and response.get('s') == 'ok':\n                orders = response.get('orderBook', [])\n                \n                for order in orders:\n                    if order.get('id') == order_id:\n                        return {\n                            'order_id': order_id,\n                            'status': order.get('status', ''),\n                            'filled_qty': order.get('filledQty', 0),\n                            'remaining_qty': order.get('remainingQty', 0),\n                            'avg_price': order.get('avgPrice', 0),\n                            'message': order.get('message', '')\n                        }\n                        \n                return {'order_id': order_id, 'status': 'NOT_FOUND'}\n                \n            else:\n                self.logger.error(f\"âŒ Failed to get order status: {response}\")\n                return {}\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error getting order status: {e}\")\n            return {}\n            \n    def cancel_order(self, order_id: str) -> bool:\n        \"\"\"Cancel LIVE order in FYERS\"\"\"\n        \n        if not self.fyers:\n            return False\n            \n        try:\n            cancel_data = {\"id\": order_id}\n            response = self.fyers.cancel_order(cancel_data)\n            \n            if response and response.get('s') == 'ok':\n                self.logger.info(f\"âœ… Order cancelled successfully: {order_id}\")\n                \n                # Update stored order\n                if order_id in self.orders:\n                    self.orders[order_id]['status'] = 'CANCELLED'\n                    \n                return True\n                \n            else:\n                self.logger.error(f\"âŒ Order cancellation failed: {response}\")\n                return False\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error cancelling order: {e}\")\n            return False\n            \n    def close_position(self, symbol: str, quantity: int = None) -> Dict:\n        \"\"\"Close LIVE position in FYERS\"\"\"\n        \n        # Get current position\n        positions = self.get_live_positions()\n        \n        if symbol not in positions:\n            return {\"status\": \"error\", \"message\": \"Position not found\"}\n            \n        position = positions[symbol]\n        position_qty = position['quantity']\n        \n        if quantity is None:\n            quantity = abs(position_qty)  # Close full position\n            \n        # Determine order side (opposite of position)\n        side = \"SELL\" if position_qty > 0 else \"BUY\"\n        \n        # Place closing order\n        result = self.place_live_order(symbol, side, quantity, \"MARKET\")\n        \n        if result['status'] == 'success':\n            self.logger.info(f\"âœ… Position closing order placed: {symbol}\")\n            \n        return result\n        \n    def get_live_quotes(self, symbols: List[str]) -> Dict:\n        \"\"\"Get LIVE quotes from FYERS\"\"\"\n        \n        if not self.fyers:\n            return {}\n            \n        try:\n            # Prepare symbols for FYERS quotes API\n            symbols_str = \",\".join(symbols)\n            \n            response = self.fyers.quotes({\"symbols\": symbols_str})\n            \n            if response and response.get('s') == 'ok':\n                quotes_data = response.get('d', {})\n                \n                live_quotes = {}\n                \n                for symbol_data in quotes_data.values():\n                    symbol = symbol_data.get('n', '')\n                    live_quotes[symbol] = {\n                        'ltp': symbol_data.get('v', {}).get('lp', 0),  # Last traded price\n                        'open': symbol_data.get('v', {}).get('o', 0),\n                        'high': symbol_data.get('v', {}).get('h', 0),\n                        'low': symbol_data.get('v', {}).get('l', 0),\n                        'volume': symbol_data.get('v', {}).get('vol', 0),\n                        'change': symbol_data.get('v', {}).get('ch', 0),\n                        'change_percent': symbol_data.get('v', {}).get('chp', 0)\n                    }\n                    \n                return live_quotes\n                \n            else:\n                self.logger.error(f\"âŒ Failed to get quotes: {response}\")\n                return {}\n                \n        except Exception as e:\n            self.logger.error(f\"âŒ Error getting live quotes: {e}\")\n            return {}\n            \n    def is_market_open(self) -> bool:\n        \"\"\"Check if Indian stock market is open\"\"\"\n        \n        now = datetime.now()\n        \n        # Check if it's a weekday (Monday=0, Sunday=6)\n        if now.weekday() > 4:  # Saturday or Sunday\n            return False\n            \n        # Indian market hours: 9:15 AM to 3:30 PM\n        market_open = now.replace(hour=9, minute=15, second=0, microsecond=0)\n        market_close = now.replace(hour=15, minute=30, second=0, microsecond=0)\n        \n        return market_open <= now <= market_close\n        \n    def get_trading_summary(self) -> Dict:\n        \"\"\"Get trading summary for today\"\"\"\n        \n        account_balance = self._get_account_balance()\n        live_positions = self.get_live_positions()\n        \n        total_pnl = sum(pos['pnl'] for pos in live_positions.values())\n        total_unrealized = sum(pos['unrealized_pnl'] for pos in live_positions.values())\n        \n        return {\n            'account_balance': account_balance,\n            'active_positions': len(live_positions),\n            'total_pnl': total_pnl,\n            'unrealized_pnl': total_unrealized,\n            'market_open': self.is_market_open(),\n            'live_trading_enabled': self.config['trading']['live_trading']\n        }\n\ndef main():\n    \"\"\"Demo FYERS live trading integration\"\"\"\n    \n    print(\"ðŸš€ FYERS LIVE TRADING INTEGRATION DEMO\")\n    print(\"=\"*50)\n    \n    # Initialize FYERS live trader\n    trader = FyersLiveTrader()\n    \n    if not trader.fyers:\n        print(\"\\nâš ï¸ FYERS API not configured for live trading\")\n        print(\"ðŸ“ Please update fyers_config.json with your API credentials\")\n        print(\"\\nðŸ“‹ Required configuration:\")\n        print(\"   â€¢ client_id: Your FYERS Client ID\")\n        print(\"   â€¢ access_token: Your FYERS Access Token\")\n        print(\"   â€¢ live_trading: Set to true for real money trading\")\n        return\n        \n    print(\"\\nâœ… FYERS API Connected Successfully!\")\n    \n    # Get trading summary\n    summary = trader.get_trading_summary()\n    \n    print(\"\\nðŸ“Š LIVE ACCOUNT SUMMARY:\")\n    print(f\"   ðŸ’° Available Balance: â‚¹{summary.get('account_balance', {}).get('available_balance', 0):,.2f}\")\n    print(f\"   ðŸ“Š Active Positions: {summary['active_positions']}\")\n    print(f\"   ðŸ’µ Total P&L: â‚¹{summary['total_pnl']:+,.2f}\")\n    print(f\"   ðŸ“ˆ Market Open: {'Yes' if summary['market_open'] else 'No'}\")\n    print(f\"   ðŸš€ Live Trading: {'Enabled' if summary['live_trading_enabled'] else 'Disabled'}\")\n    \n    # Demo live data\n    print(\"\\nðŸ“ˆ GETTING LIVE MARKET DATA:\")\n    \n    test_symbols = [\"NSE:RELIANCE-EQ\", \"NSE:TCS-EQ\"]\n    \n    for symbol in test_symbols:\n        data = trader.get_live_market_data(symbol, \"1\", 5)\n        \n        if not data.empty:\n            current_price = data['close'].iloc[-1]\n            change = data['close'].iloc[-1] - data['close'].iloc[-2] if len(data) > 1 else 0\n            change_pct = (change / data['close'].iloc[-2]) * 100 if len(data) > 1 and data['close'].iloc[-2] != 0 else 0\n            \n            change_icon = \"ðŸ“ˆ\" if change > 0 else \"ðŸ“‰\" if change < 0 else \"âž¡ï¸\"\n            \n            print(f\"   {symbol}: â‚¹{current_price:.2f} {change_icon} {change:+.2f} ({change_pct:+.2f}%)\")\n        else:\n            print(f\"   {symbol}: No data available\")\n            \n    # Get live quotes\n    print(\"\\nðŸ’¹ LIVE QUOTES:\")\n    \n    quotes = trader.get_live_quotes(test_symbols)\n    \n    for symbol, quote in quotes.items():\n        print(f\"   {symbol}: â‚¹{quote['ltp']:.2f} (Change: {quote['change_percent']:+.2f}%)\")\n        \n    print(\"\\nâœ… FYERS Live Trading Demo Complete!\")\n    print(\"ðŸŽ¯ Ready for automated trading with real money\")\n    print(\"\\nâš ï¸ WARNING: This will trade with REAL MONEY when live_trading is enabled!\")\n\nif __name__ == \"__main__\":\n    main()
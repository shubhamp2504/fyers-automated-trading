"""
Enhanced Live Supply/Demand Zone Trading System
==============================================

LIVE DATA ONLY trading system focused on supply and demand zones
- Real-time zone identification and tracking
- Enhanced profit extraction from zone bounces/rejections
- Live market data streaming and analysis
- Professional money management

‚ö†Ô∏è LIVE TRADING ONLY: Uses actual market data and real order execution
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import json
import time
import threading
from typing import Dict, List, Tuple, Optional
from dataclasses import dataclass
from enum import Enum
import sys
import warnings
warnings.filterwarnings('ignore')

# Import enhanced modules
sys.path.append('api_reference/market_data')
sys.path.append('api_reference/orders')
sys.path.append('api_reference/portfolio')
sys.path.append('api_reference/websocket')

from market_data_complete import FyersMarketData
from orders_complete import FyersOrders  
from portfolio_complete import FyersPortfolio
from index_intraday_strategy import IndexIntradayStrategy, SignalType, TradingSignal

class ZoneType(Enum):
    SUPPLY = "SUPPLY"
    DEMAND = "DEMAND"
    STRONG_SUPPLY = "STRONG_SUPPLY"
    STRONG_DEMAND = "STRONG_DEMAND"

@dataclass
class SupplyDemandZone:
    """Supply/Demand zone tracking"""
    zone_type: ZoneType
    level: float
    strength: int
    volume: int
    time_created: datetime
    last_test: datetime
    test_count: int
    success_rate: float
    is_active: bool

@dataclass
class LiveZoneTrade:
    """Enhanced trade tracking for zone-based trades"""
    trade_id: str
    symbol: str
    signal: SignalType
    entry_time: datetime
    entry_price: float
    quantity: int
    stop_loss: float
    target_1: float
    target_2: float
    current_price: float
    unrealized_pnl: float
    zone_used: Optional[SupplyDemandZone]
    zone_strength: int
    enhanced_targets: bool  # If targets were increased due to strong zone
    status: str
    order_ids: List[str]

class LiveSupplyDemandTrading:
    """
    Live trading system focused on supply and demand zones
    MAKING MONEY through powerful zone identification
    """
    
    def __init__(self, config_file: str = 'config.json'):
        # Load configuration
        with open(config_file, 'r') as f:
            self.config = json.load(f)
        
        # Initialize FYERS APIs for LIVE data
        self.market_data = FyersMarketData(self.config['client_id'], self.config['access_token'])
        self.orders = FyersOrders(self.config['client_id'], self.config['access_token'])
        self.portfolio = FyersPortfolio(self.config['client_id'], self.config['access_token'])
        
        # Enhanced strategy with supply/demand focus
        self.strategy = IndexIntradayStrategy(self.config['client_id'], self.config['access_token'])
        
        # Trading configuration - ENHANCED for ZONES
        self.trading_symbols = {
            'NIFTY': 'NSE:NIFTY50-INDEX',
            'BANKNIFTY': 'NSE:NIFTYBANK-INDEX'
        }
        
        # Enhanced risk management for zone trading
        self.max_daily_loss = 3000  # Tighter control - zone trades are higher probability
        self.max_positions = 2  # Focus on quality over quantity
        self.base_position_size = 1  # Base lot size
        self.zone_position_multiplier = 1.5  # Increase size for strong zones
        
        # Supply/Demand zone management
        self.active_zones: Dict[str, List[SupplyDemandZone]] = {}\n        self.zone_history: Dict[str, List[SupplyDemandZone]] = {}\n        self.min_zone_strength = 2  # Minimum tests required\n        self.strong_zone_strength = 4  # Strong zone threshold\n        self.zone_proximity_percent = 0.25  # 0.25% proximity for zone triggers\n        \n        # Live trading state\n        self.active_trades: Dict[str, LiveZoneTrade] = {}\n        self.daily_pnl = 0\n        self.zone_trade_count = 0\n        self.total_trades_today = 0\n        self.is_trading_active = False\n        self.last_zone_scan = {}\n        \n        # Enhanced market hours for zone analysis\n        self.market_open_time = \"09:15\"\n        self.market_close_time = \"15:15\"\n        self.strategy_stop_time = \"14:15\"  # Earlier stop for zone analysis\n        self.zone_scan_interval = 60  # Scan zones every minute\n        \n        # Monitoring threads\n        self.monitoring_thread = None\n        self.zone_tracking_thread = None\n        self.stop_monitoring = False\n        \n        print(\"üí∞ SUPPLY/DEMAND ZONE TRADING SYSTEM INITIALIZED\")\n        print(f\"üéØ Focus: Making money through powerful zone identification\")\n        print(f\"üìä Symbols: {list(self.trading_symbols.keys())}\")\n        print(f\"üíé Zone Strategy: Enhanced profits from supply/demand levels\")\n        print(f\"üõ°Ô∏è Risk Management: Tighter controls for higher probability trades\")\n    \n    def scan_live_supply_demand_zones(self, symbol: str) -> List[SupplyDemandZone]:\n        \"\"\"Scan for supply and demand zones using LIVE data\"\"\"\n        \n        try:\n            # Get LIVE 1H data for zone identification\n            data_1h = self.strategy.get_market_data(symbol, \"60\", days=15)\n            if data_1h.empty:\n                return []\n            \n            # Calculate indicators on live data\n            data_1h = self.strategy.calculate_technical_indicators(data_1h)\n            \n            # Get current LIVE price\n            current_quotes = self.market_data.get_quotes([symbol])\n            if not current_quotes:\n                return []\n            \n            current_price = current_quotes[0].get('lp', 0)\n            if current_price == 0:\n                return []\n            \n            zones = []\n            recent_data = data_1h.tail(50)  # Last 50 hours for zone analysis\n            \n            # Advanced supply zone detection (HIGH VOLUME REJECTION AREAS)\n            for i in range(10, len(recent_data) - 5):\n                candle = recent_data.iloc[i]\n                \n                # Supply Zone: High volume rejection with multiple tests\n                if (candle['high'] == recent_data['high'].iloc[i-5:i+6].max() and\n                    candle['volume'] > recent_data['volume'].iloc[i-10:i+10].mean() * 1.8):\n                    \n                    zone_level = candle['high']\n                    zone_strength = 0\n                    last_test_time = candle.name\n                    \n                    # Count rejections (tests) at this zone\n                    for j in range(i+1, len(recent_data)):\n                        test_candle = recent_data.iloc[j]\n                        zone_distance = abs(test_candle['high'] - zone_level) / zone_level * 100\n                        \n                        if zone_distance <= 0.3:  # Within 0.3% of zone\n                            if test_candle['close'] < test_candle['open']:  # Rejection candle\n                                zone_strength += 1\n                                last_test_time = test_candle.name\n                    \n                    # Only include zones with multiple tests\n                    if zone_strength >= self.min_zone_strength:\n                        zone_type = ZoneType.STRONG_SUPPLY if zone_strength >= self.strong_zone_strength else ZoneType.SUPPLY\n                        \n                        # Check proximity to current price for relevance\n                        price_distance = abs(current_price - zone_level) / current_price * 100\n                        if price_distance <= 2.0:  # Within 2% of current price\n                            zones.append(SupplyDemandZone(\n                                zone_type=zone_type,\n                                level=zone_level,\n                                strength=zone_strength,\n                                volume=int(candle['volume']),\n                                time_created=candle.name,\n                                last_test=last_test_time,\n                                test_count=zone_strength,\n                                success_rate=min(zone_strength * 0.15 + 0.6, 0.95),  # Higher success for more tests\n                                is_active=True\n                            ))\n                \n                # Demand Zone: High volume support with multiple bounces\n                if (candle['low'] == recent_data['low'].iloc[i-5:i+6].min() and\n                    candle['volume'] > recent_data['volume'].iloc[i-10:i+10].mean() * 1.8):\n                    \n                    zone_level = candle['low']\n                    zone_strength = 0\n                    last_test_time = candle.name\n                    \n                    # Count bounces (tests) at this zone\n                    for j in range(i+1, len(recent_data)):\n                        test_candle = recent_data.iloc[j]\n                        zone_distance = abs(test_candle['low'] - zone_level) / zone_level * 100\n                        \n                        if zone_distance <= 0.3:  # Within 0.3% of zone\n                            if test_candle['close'] > test_candle['open']:  # Bounce candle\n                                zone_strength += 1\n                                last_test_time = test_candle.name\n                    \n                    # Only include zones with multiple tests\n                    if zone_strength >= self.min_zone_strength:\n                        zone_type = ZoneType.STRONG_DEMAND if zone_strength >= self.strong_zone_strength else ZoneType.DEMAND\n                        \n                        # Check proximity to current price for relevance\n                        price_distance = abs(current_price - zone_level) / current_price * 100\n                        if price_distance <= 2.0:  # Within 2% of current price\n                            zones.append(SupplyDemandZone(\n                                zone_type=zone_type,\n                                level=zone_level,\n                                strength=zone_strength,\n                                volume=int(candle['volume']),\n                                time_created=candle.name,\n                                last_test=last_test_time,\n                                test_count=zone_strength,\n                                success_rate=min(zone_strength * 0.15 + 0.6, 0.95),  # Higher success for more tests\n                                is_active=True\n                            ))\n            \n            # Sort zones by strength and proximity\n            zones = sorted(zones, key=lambda z: (z.strength, -abs(current_price - z.level)), reverse=True)\n            \n            # Update zone tracking\n            symbol_key = symbol.split(':')[1]\n            self.active_zones[symbol_key] = zones[:5]  # Keep top 5 zones\n            \n            if zones:\n                print(f\"üíé LIVE ZONES IDENTIFIED for {symbol_key}: {len(zones)} zones\")\n                for zone in zones[:3]:  # Show top 3\n                    distance = abs(current_price - zone.level) / current_price * 100\n                    print(f\"   üéØ {zone.zone_type.value}: ‚Çπ{zone.level:.2f} | Strength: {zone.strength} | Distance: {distance:.2f}%\")\n            \n            return zones\n            \n        except Exception as e:\n            print(f\"‚ùå Error scanning zones for {symbol}: {e}\")\n            return []\n    \n    def generate_zone_signal(self, symbol: str) -> Optional[TradingSignal]:\n        \"\"\"Generate trading signals based on supply/demand zones - LIVE DATA ONLY\"\"\"\n        \n        try:\n            # Get fresh zones from live data\n            zones = self.scan_live_supply_demand_zones(symbol)\n            if not zones:\n                return None\n            \n            # Get current LIVE market price\n            current_quotes = self.market_data.get_quotes([symbol])\n            if not current_quotes:\n                return None\n            \n            current_price = current_quotes[0].get('lp', 0)\n            if current_price == 0:\n                return None\n            \n            # Get live 5M data for confirmation\n            data_5m = self.strategy.get_market_data(symbol, \"5\", days=2)\n            if data_5m.empty:\n                return None\n            \n            data_5m = self.strategy.calculate_technical_indicators(data_5m)\n            latest_5m = data_5m.iloc[-1]\n            \n            # Check each zone for trading opportunity\n            for zone in zones:\n                zone_distance = abs(current_price - zone.level) / current_price * 100\n                \n                # DEMAND ZONE - BUY SIGNAL (Price approaching demand, expect bounce)\n                if zone.zone_type in [ZoneType.DEMAND, ZoneType.STRONG_DEMAND] and zone_distance <= self.zone_proximity_percent:\n                    # Additional confirmation from 5M data\n                    if (latest_5m['EMA_9'] > latest_5m['EMA_21'] and  # Trend alignment\n                        35 < latest_5m['RSI'] < 65 and  # Not extreme\n                        current_price > latest_5m['VWAP'] * 0.999):  # Near or above VWAP\n                        \n                        # Enhanced targets for strong zones\n                        base_target_1 = 22\n                        base_target_2 = 30\n                        \n                        if zone.zone_type == ZoneType.STRONG_DEMAND:\n                            base_target_1 = 28  # Increased from 22\n                            base_target_2 = 40  # Increased from 30\n                        \n                        # Smart stop loss below demand zone\n                        stop_loss = max(\n                            zone.level - 8,  # Below demand zone\n                            current_price - 15  # Max 15 points risk\n                        )\n                        \n                        signal = TradingSignal(\n                            signal=SignalType.BUY,\n                            entry_price=current_price,\n                            stop_loss=stop_loss,\n                            target_1=current_price + base_target_1,\n                            target_2=current_price + base_target_2,\n                            confidence=min(0.7 + (zone.strength * 0.05), 0.95),\n                            timestamp=datetime.now(),\n                            reason=f\"DEMAND ZONE BOUNCE: {zone.zone_type.value} @ ‚Çπ{zone.level:.2f} | Strength: {zone.strength} | Success Rate: {zone.success_rate:.1%}\"\n                        )\n                        \n                        return signal\n                \n                # SUPPLY ZONE - SELL SIGNAL (Price approaching supply, expect rejection)\n                elif zone.zone_type in [ZoneType.SUPPLY, ZoneType.STRONG_SUPPLY] and zone_distance <= self.zone_proximity_percent:\n                    # Additional confirmation from 5M data\n                    if (latest_5m['EMA_9'] < latest_5m['EMA_21'] and  # Trend alignment\n                        35 < latest_5m['RSI'] < 65 and  # Not extreme\n                        current_price < latest_5m['VWAP'] * 1.001):  # Near or below VWAP\n                        \n                        # Enhanced targets for strong zones\n                        base_target_1 = 22\n                        base_target_2 = 30\n                        \n                        if zone.zone_type == ZoneType.STRONG_SUPPLY:\n                            base_target_1 = 28  # Increased from 22\n                            base_target_2 = 40  # Increased from 30\n                        \n                        # Smart stop loss above supply zone\n                        stop_loss = min(\n                            zone.level + 8,  # Above supply zone\n                            current_price + 15  # Max 15 points risk\n                        )\n                        \n                        signal = TradingSignal(\n                            signal=SignalType.SELL,\n                            entry_price=current_price,\n                            stop_loss=stop_loss,\n                            target_1=current_price - base_target_1,\n                            target_2=current_price - base_target_2,\n                            confidence=min(0.7 + (zone.strength * 0.05), 0.95),\n                            timestamp=datetime.now(),\n                            reason=f\"SUPPLY ZONE REJECTION: {zone.zone_type.value} @ ‚Çπ{zone.level:.2f} | Strength: {zone.strength} | Success Rate: {zone.success_rate:.1%}\"\n                        )\n                        \n                        return signal\n            \n            return None  # No zone opportunities\n            \n        except Exception as e:\n            print(f\"‚ùå Error generating zone signal for {symbol}: {e}\")\n            return None\n    \n    def execute_zone_trade(self, signal: TradingSignal, symbol: str, zone: SupplyDemandZone) -> bool:\n        \"\"\"Execute trade with enhanced position sizing for zones\"\"\"\n        \n        try:\n            # Calculate enhanced position size for zone trades\n            if 'NIFTY50' in symbol:\n                base_lot_size = 25\n            elif 'NIFTYBANK' in symbol:\n                base_lot_size = 15\n            else:\n                base_lot_size = 25\n            \n            # Increase position size for strong zones (more profit potential)\n            position_multiplier = self.base_position_size\n            if zone and zone.zone_type in [ZoneType.STRONG_SUPPLY, ZoneType.STRONG_DEMAND]:\n                position_multiplier = self.zone_position_multiplier\n                print(f\"üíé STRONG ZONE DETECTED: Increasing position size by {position_multiplier}x\")\n            \n            quantity = int(base_lot_size * position_multiplier)\n            side = 1 if signal.signal == SignalType.BUY else -1\n            \n            print(f\"üí∞ EXECUTING ZONE TRADE: {signal.signal.value} {quantity} units of {symbol}\")\n            print(f\"üéØ Zone: {zone.zone_type.value if zone else 'UNKNOWN'} @ ‚Çπ{zone.level if zone else 'N/A'}\")\n            \n            # Place market order for immediate execution\n            order_result = self.orders.place_order(\n                symbol=symbol,\n                qty=quantity,\n                side=side,\n                type=1,  # Market order\n                product_type=\"INTRADAY\"\n            )\n            \n            if order_result and 'id' in order_result:\n                order_id = order_result['id']\n                trade_id = f\"ZONE_{symbol}_{int(datetime.now().timestamp())}\"\n                \n                # Enhanced targets for strong zones\n                enhanced_targets = zone and zone.zone_type in [ZoneType.STRONG_SUPPLY, ZoneType.STRONG_DEMAND]\n                \n                # Create enhanced trade record\n                zone_trade = LiveZoneTrade(\n                    trade_id=trade_id,\n                    symbol=symbol,\n                    signal=signal.signal,\n                    entry_time=datetime.now(),\n                    entry_price=signal.entry_price,\n                    quantity=quantity,\n                    stop_loss=signal.stop_loss,\n                    target_1=signal.target_1,\n                    target_2=signal.target_2,\n                    current_price=signal.entry_price,\n                    unrealized_pnl=0,\n                    zone_used=zone,\n                    zone_strength=zone.strength if zone else 0,\n                    enhanced_targets=enhanced_targets,\n                    status='ENTERED',\n                    order_ids=[order_id]\n                )\n                \n                self.active_trades[trade_id] = zone_trade\n                self.total_trades_today += 1\n                self.zone_trade_count += 1\n                \n                print(f\"‚úÖ ZONE TRADE EXECUTED!\")\n                print(f\"   üìä Trade ID: {trade_id}\")\n                print(f\"   üíé Zone Strength: {zone.strength if zone else 0}\")\n                print(f\"   üìà Enhanced Targets: {'YES' if enhanced_targets else 'NO'}\")\n                print(f\"   üéØ Expected Success Rate: {zone.success_rate:.1%} if zone else 'N/A'}\")\n                \n                return True\n            else:\n                print(f\"‚ùå Failed to execute zone trade: {order_result}\")\n                return False\n                \n        except Exception as e:\n            print(f\"‚ùå Error executing zone trade: {e}\")\n            return False\n    \n    def monitor_zone_positions(self):\n        \"\"\"Enhanced position monitoring for zone trades\"\"\"\n        \n        if not self.active_trades:\n            return\n        \n        for trade_id, trade in list(self.active_trades.items()):\n            try:\n                # Get current LIVE market price\n                current_price = self.get_current_live_price(trade.symbol)\n                if not current_price:\n                    continue\n                \n                # Update trade with current data\n                trade.current_price = current_price\n                \n                if trade.signal == SignalType.BUY:\n                    unrealized_pnl = (current_price - trade.entry_price) * trade.quantity\n                else:\n                    unrealized_pnl = (trade.entry_price - current_price) * trade.quantity\n                \n                trade.unrealized_pnl = unrealized_pnl\n                \n                # Enhanced exit logic for zone trades\n                should_exit = False\n                exit_reason = \"\"\n                \n                if trade.signal == SignalType.BUY:\n                    # Buy position exits\n                    if current_price <= trade.stop_loss:\n                        should_exit = True\n                        exit_reason = \"ZONE_STOP_LOSS\"\n                    elif current_price >= trade.target_2:\n                        should_exit = True\n                        exit_reason = \"ZONE_TARGET_2\"\n                    elif current_price >= trade.target_1 and trade.status == 'ENTERED':\n                        # Enhanced partial exit for zone trades\n                        self.partial_exit_zone_position(trade_id, \"ZONE_TARGET_1\")\n                        continue\n                else:\n                    # Sell position exits\n                    if current_price >= trade.stop_loss:\n                        should_exit = True\n                        exit_reason = \"ZONE_STOP_LOSS\"\n                    elif current_price <= trade.target_2:\n                        should_exit = True\n                        exit_reason = \"ZONE_TARGET_2\"\n                    elif current_price <= trade.target_1 and trade.status == 'ENTERED':\n                        # Enhanced partial exit for zone trades\n                        self.partial_exit_zone_position(trade_id, \"ZONE_TARGET_1\")\n                        continue\n                \n                # Force exit near market close\n                current_time = datetime.now().strftime(\"%H:%M\")\n                if current_time > \"14:45\":\n                    should_exit = True\n                    exit_reason = \"ZONE_MARKET_CLOSE\"\n                \n                if should_exit:\n                    self.exit_zone_position(trade_id, exit_reason)\n                \n            except Exception as e:\n                print(f\"‚ùå Error monitoring zone position {trade_id}: {e}\")\n                continue\n    \n    def get_current_live_price(self, symbol: str) -> Optional[float]:\n        \"\"\"Get current LIVE market price\"\"\"\n        try:\n            quotes = self.market_data.get_quotes([symbol])\n            if quotes and len(quotes) > 0:\n                return quotes[0].get('lp', 0)\n            return None\n        except Exception as e:\n            print(f\"‚ùå Error getting live price for {symbol}: {e}\")\n            return None\n    \n    def start_zone_trading(self):\n        \"\"\"Start the enhanced supply/demand zone trading system\"\"\"\n        \n        print(f\"üí∞ STARTING LIVE SUPPLY/DEMAND ZONE TRADING SYSTEM\")\n        print(f\"üéØ Focus: Making money through powerful zone identification\")\n        print(f\"‚è∞ Market Hours: {self.market_open_time} - {self.market_close_time}\")\n        print(f\"üõë Strategy Stop Time: {self.strategy_stop_time}\")\n        \n        self.is_trading_active = True\n        self.stop_monitoring = False\n        \n        # Start enhanced monitoring threads\n        self.monitoring_thread = threading.Thread(target=self.enhanced_trading_loop, daemon=True)\n        self.zone_tracking_thread = threading.Thread(target=self.continuous_zone_tracking, daemon=True)\n        \n        self.monitoring_thread.start()\n        self.zone_tracking_thread.start()\n        \n        print(f\"‚úÖ ZONE TRADING SYSTEM ACTIVE!\")\n        print(f\"üí° Press Ctrl+C to stop trading\")\n        \n        try:\n            # Enhanced dashboard loop\n            while self.is_trading_active:\n                self.display_zone_trading_dashboard()\n                time.sleep(30)  # Update every 30 seconds\n                \n        except KeyboardInterrupt:\n            print(f\"\\nüõë Stopping zone trading system...\")\n            self.stop_zone_trading()\n    \n    def enhanced_trading_loop(self):\n        \"\"\"Enhanced trading loop focused on supply/demand zones\"\"\"\n        \n        while not self.stop_monitoring:\n            try:\n                # Check market and trading conditions\n                if not self.can_place_new_trades():\n                    time.sleep(60)\n                    continue\n                \n                # Scan each symbol for zone opportunities\n                for name, symbol in self.trading_symbols.items():\n                    try:\n                        # Generate zone-based signals\n                        signal = self.generate_zone_signal(symbol)\n                        \n                        if signal and signal.confidence >= 0.8:  # High confidence zone trades only\n                            print(f\"üíé HIGH CONFIDENCE ZONE SIGNAL: {name}\")\n                            print(f\"üéØ {signal.reason}\")\n                            \n                            # Get the zone that triggered this signal\n                            symbol_key = symbol.split(':')[1]\n                            zones = self.active_zones.get(symbol_key, [])\n                            relevant_zone = zones[0] if zones else None\n                            \n                            # Execute zone trade with enhanced sizing\n                            if self.execute_zone_trade(signal, symbol, relevant_zone):\n                                print(f\"‚úÖ Zone trade executed for {name}\")\n                                # Brief pause after execution\n                                time.sleep(10)\n                            else:\n                                print(f\"‚ùå Failed to execute zone trade for {name}\")\n                        \n                        time.sleep(5)  # Brief pause between symbols\n                        \n                    except Exception as e:\n                        print(f\"‚ùå Error processing {name}: {e}\")\n                        continue\n                \n                # Monitor active zone positions\n                self.monitor_zone_positions()\n                \n                # Wait before next scan\n                time.sleep(self.zone_scan_interval)  # Scan every minute\n                \n            except Exception as e:\n                print(f\"‚ùå Error in zone trading loop: {e}\")\n                time.sleep(30)\n    \n    def display_zone_trading_dashboard(self):\n        \"\"\"Enhanced dashboard showing zone trading performance\"\"\"\n        \n        print(f\"\\n\" + \"=\"*70)\n        print(f\"üí∞ LIVE SUPPLY/DEMAND ZONE TRADING DASHBOARD\")\n        print(f\"‚è∞ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\")\n        print(f\"=\"*70)\n        \n        # Enhanced market and trading status\n        market_status = \"üü¢ OPEN\" if self.is_market_open() else \"üî¥ CLOSED\"\n        trading_status = \"üíé ZONE HUNTING\" if self.is_trading_active else \"‚è∏Ô∏è PAUSED\"\n        \n        print(f\"üìä Market: {market_status} | Status: {trading_status}\")\n        print(f\"üí∞ Daily P&L: ‚Çπ{self.daily_pnl:+,.2f}\")\n        print(f\"üéØ Total Trades: {self.total_trades_today} | Zone Trades: {self.zone_trade_count}\")\n        print(f\"üìà Active Positions: {len(self.active_trades)}\")\n        \n        # Show active zones\n        print(f\"\\nüíé ACTIVE SUPPLY/DEMAND ZONES:\")\n        print(\"-\" * 60)\n        for symbol_key, zones in self.active_zones.items():\n            if zones:\n                current_price = self.get_current_live_price(self.trading_symbols.get(symbol_key.replace('-INDEX', ''), ''))\n                print(f\"üìä {symbol_key}:\")\n                for zone in zones[:3]:  # Top 3 zones\n                    distance = abs(current_price - zone.level) / current_price * 100 if current_price else 0\n                    proximity_indicator = \"üî•\" if distance <= self.zone_proximity_percent else \"üìç\"\n                    strength_indicator = \"üíé\" if zone.strength >= self.strong_zone_strength else \"‚≠ê\"\n                    print(f\"   {proximity_indicator} {strength_indicator} {zone.zone_type.value}: ‚Çπ{zone.level:.2f} | Strength: {zone.strength} | Distance: {distance:.2f}%\")\n        \n        # Show active trades\n        if self.active_trades:\n            print(f\"\\nüéØ ACTIVE ZONE TRADES:\")\n            print(\"-\" * 60)\n            for trade_id, trade in self.active_trades.items():\n                pnl_indicator = \"üí∞\" if trade.unrealized_pnl > 0 else \"üìâ\" if trade.unrealized_pnl < 0 else \"‚ûñ\"\n                zone_indicator = \"üíé\" if trade.enhanced_targets else \"‚≠ê\"\n                print(f\"{pnl_indicator} {zone_indicator} {trade.symbol} {trade.signal.value}\")\n                print(f\"   üìä Entry: ‚Çπ{trade.entry_price:.2f} | Current: ‚Çπ{trade.current_price:.2f} | P&L: ‚Çπ{trade.unrealized_pnl:+.2f}\")\n                print(f\"   üéØ Targets: ‚Çπ{trade.target_1:.2f} | ‚Çπ{trade.target_2:.2f} | SL: ‚Çπ{trade.stop_loss:.2f}\")\n                if trade.zone_used:\n                    print(f\"   üíé Zone: {trade.zone_used.zone_type.value} | Strength: {trade.zone_strength}\")\n        else:\n            print(f\"\\n‚è∏Ô∏è No active zone trades - Scanning for opportunities...\")\n        \n        print(f\"=\"*70)\n    \n    def is_market_open(self) -> bool:\n        \"\"\"Check if market is open\"\"\"\n        now = datetime.now()\n        current_time = now.strftime(\"%H:%M\")\n        current_weekday = now.weekday()\n        \n        if current_weekday >= 5:  # Weekend\n            return False\n        \n        return self.market_open_time <= current_time <= self.market_close_time\n    \n    def can_place_new_trades(self) -> bool:\n        \"\"\"Check if new trades can be placed\"\"\"\n        now = datetime.now()\n        current_time = now.strftime(\"%H:%M\")\n        \n        if not self.is_market_open():\n            return False\n        \n        if current_time > self.strategy_stop_time:\n            return False\n        \n        if self.daily_pnl <= -self.max_daily_loss:\n            print(f\"üõë Daily loss limit reached: ‚Çπ{self.daily_pnl:,.2f}\")\n            return False\n        \n        if len(self.active_trades) >= self.max_positions:\n            return False\n        \n        return True\n\ndef main():\n    \"\"\"Main function for supply/demand zone trading\"\"\"\n    \n    print(f\"üí∞ LIVE SUPPLY/DEMAND ZONE TRADING SYSTEM\")\n    print(f\"üéØ Focus: Making money through powerful zone identification\")\n    print(f\"=\"*60)\n    \n    try:\n        # Initialize enhanced trading system\n        zone_trading = LiveSupplyDemandTrading()\n        \n        print(f\"\\nüìä System Checks:\")\n        print(f\"   Market Open: {'‚úÖ' if zone_trading.is_market_open() else '‚ùå'}\")\n        print(f\"   Can Trade: {'‚úÖ' if zone_trading.can_place_new_trades() else '‚ùå'}\")\n        \n        if not zone_trading.is_market_open():\n            print(f\"\\n‚è∞ Market is closed. Zone analysis will resume during market hours.\")\n            print(f\"üìÖ Market Hours: {zone_trading.market_open_time} - {zone_trading.market_close_time}\")\n            return\n        \n        # Confirmation for live trading\n        print(f\"\\nüö® LIVE TRADING WARNING:\")\n        print(f\"   üí∞ This system will place REAL trades with actual money\")\n        print(f\"   üéØ Focus: Supply/Demand zones for maximum profit\")\n        print(f\"   ‚ö†Ô∏è Ensure you understand the risks before proceeding\")\n        \n        confirm = input(f\"\\nüéØ Start LIVE zone trading? (START/cancel): \")\n        \n        if confirm == 'START':\n            zone_trading.start_zone_trading()\n        else:\n            print(f\"üìä Zone trading cancelled\")\n            \n    except Exception as e:\n        print(f\"‚ùå Error in zone trading system: {e}\")\n        import traceback\n        traceback.print_exc()\n\nif __name__ == \"__main__\":\n    main()
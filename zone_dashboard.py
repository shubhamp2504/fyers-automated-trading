"""
Supply/Demand Zone Trading Dashboard
===================================

Comprehensive dashboard for live zone trading with real-time monitoring
- Live zone identification and tracking
- Real-time trade management
- Performance analytics
- Risk monitoring

üí∞ Making money through powerful zone identification and live trading
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta\nimport json\nimport time\nimport threading\nfrom typing import Dict, List, Tuple, Optional\nimport matplotlib.pyplot as plt\nfrom matplotlib.animation import FuncAnimation\nimport matplotlib.dates as mdates\nfrom collections import deque\nimport warnings\nwarnings.filterwarnings('ignore')\n\n# Import our zone trading components\ntry:\n    from live_zone_trading import LiveSupplyDemandTrading, ZoneType, SupplyDemandZone\n    from zone_analyzer import ZoneAnalyzer\nexcept ImportError as e:\n    print(f\"‚ùå Import error: {e}\")\n    print(f\"üí° Ensure live_zone_trading.py and zone_analyzer.py are in the same directory\")\n    exit(1)\n\nclass ZoneTradingDashboard:\n    \"\"\"\n    Comprehensive dashboard for supply/demand zone trading\n    Live monitoring, analysis, and trade management\n    \"\"\"\n    \n    def __init__(self, config_file: str = 'config.json'):\n        # Initialize core components\n        self.zone_trading = LiveSupplyDemandTrading(config_file)\n        self.zone_analyzer = ZoneAnalyzer(config_file)\n        \n        # Dashboard configuration\n        self.update_interval = 30  # Dashboard update frequency (seconds)\n        self.chart_history_minutes = 240  # 4 hours of price history\n        \n        # Performance tracking\n        self.performance_history = {\n            'timestamps': deque(maxlen=100),\n            'pnl_values': deque(maxlen=100),\n            'trade_counts': deque(maxlen=100),\n            'zone_opportunities': deque(maxlen=100),\n            'success_rates': deque(maxlen=100)\n        }\n        \n        # Live data tracking\n        self.live_prices = {\n            'NIFTY': deque(maxlen=self.chart_history_minutes),\n            'BANKNIFTY': deque(maxlen=self.chart_history_minutes)\n        }\n        \n        self.live_timestamps = deque(maxlen=self.chart_history_minutes)\n        \n        # Dashboard state\n        self.is_dashboard_active = False\n        self.dashboard_thread = None\n        \n        print(\"üíé ZONE TRADING DASHBOARD INITIALIZED\")\n        print(f\"üéØ Real-time monitoring and zone analysis\")\n        print(f\"üìä Update interval: {self.update_interval} seconds\")\n    \n    def collect_live_data(self):\n        \"\"\"Collect live market data for dashboard\"\"\"\n        \n        try:\n            current_time = datetime.now()\n            self.live_timestamps.append(current_time)\n            \n            # Collect live prices\n            for symbol_name, symbol_code in self.zone_trading.trading_symbols.items():\n                live_price = self.zone_trading.get_current_live_price(symbol_code)\n                if live_price:\n                    self.live_prices[symbol_name].append(live_price)\n                else:\n                    # Use last known price if current unavailable\n                    if self.live_prices[symbol_name]:\n                        self.live_prices[symbol_name].append(self.live_prices[symbol_name][-1])\n                    else:\n                        self.live_prices[symbol_name].append(0)\n            \n            # Update performance metrics\n            total_trades = len(self.zone_trading.active_trades)\n            successful_trades = len([t for t in self.zone_trading.active_trades.values() \n                                   if t.unrealized_pnl > 0])\n            success_rate = successful_trades / max(total_trades, 1) * 100\n            \n            zone_opportunities = 0\n            for symbol_zones in self.zone_trading.active_zones.values():\n                zone_opportunities += len([z for z in symbol_zones \n                                         if abs(self.live_prices[list(self.live_prices.keys())[0]][-1] - z.level) / \n                                         z.level * 100 <= 0.5])  # Zones within 0.5%\n            \n            self.performance_history['timestamps'].append(current_time)\n            self.performance_history['pnl_values'].append(self.zone_trading.daily_pnl)\n            self.performance_history['trade_counts'].append(total_trades)\n            self.performance_history['zone_opportunities'].append(zone_opportunities)\n            self.performance_history['success_rates'].append(success_rate)\n            \n        except Exception as e:\n            print(f\"‚ùå Error collecting live data: {e}\")\n    \n    def display_live_dashboard(self):\n        \"\"\"Display comprehensive live trading dashboard\"\"\"\n        \n        # Clear screen for fresh dashboard\n        import os\n        os.system('cls' if os.name == 'nt' else 'clear')\n        \n        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n        \n        print(f\"üíé LIVE ZONE TRADING DASHBOARD - {current_time}\")\n        print(f\"=\"*80)\n        \n        # Market status\n        market_status = \"üü¢ OPEN\" if self.zone_trading.is_market_open() else \"üî¥ CLOSED\"\n        trading_status = \"üíé ZONE HUNTING\" if self.zone_trading.is_trading_active else \"‚è∏Ô∏è PAUSED\"\n        \n        print(f\"üìä Market: {market_status} | Trading: {trading_status}\")\n        \n        # Live prices\n        print(f\"\\nüí∞ LIVE PRICES:\")\n        print(\"-\" * 30)\n        for symbol_name, symbol_code in self.zone_trading.trading_symbols.items():\n            current_price = self.zone_trading.get_current_live_price(symbol_code)\n            if current_price:\n                # Calculate price change if we have history\n                if len(self.live_prices[symbol_name]) > 1:\n                    prev_price = self.live_prices[symbol_name][-2]\n                    change = current_price - prev_price\n                    change_pct = change / prev_price * 100\n                    change_indicator = \"üìà\" if change > 0 else \"üìâ\" if change < 0 else \"‚ûñ\"\n                    print(f\"   {change_indicator} {symbol_name}: ‚Çπ{current_price:.2f} ({change:+.2f}, {change_pct:+.2f}%)\")\n                else:\n                    print(f\"   üìä {symbol_name}: ‚Çπ{current_price:.2f}\")\n        \n        # Performance summary\n        print(f\"\\nüìà TODAY'S PERFORMANCE:\")\n        print(\"-\" * 35)\n        print(f\"   üí∞ Daily P&L: ‚Çπ{self.zone_trading.daily_pnl:+,.2f}\")\n        print(f\"   üéØ Total Trades: {self.zone_trading.total_trades_today}\")\n        print(f\"   üíé Zone Trades: {self.zone_trading.zone_trade_count}\")\n        print(f\"   üìä Active Positions: {len(self.zone_trading.active_trades)}\")\n        \n        # Calculate success rate\n        if self.zone_trading.active_trades:\n            profitable_trades = len([t for t in self.zone_trading.active_trades.values() if t.unrealized_pnl > 0])\n            success_rate = profitable_trades / len(self.zone_trading.active_trades) * 100\n            print(f\"   ‚úÖ Success Rate: {success_rate:.1f}%\")\n        \n        # Active zones overview\n        print(f\"\\nüíé ACTIVE SUPPLY/DEMAND ZONES:\")\n        print(\"-\" * 50)\n        \n        total_zones = 0\n        strong_zones = 0\n        immediate_opportunities = 0\n        \n        for symbol_name, symbol_code in self.zone_trading.trading_symbols.items():\n            symbol_key = symbol_code.split(':')[1]\n            zones = self.zone_trading.active_zones.get(symbol_key, [])\n            \n            if zones:\n                current_price = self.zone_trading.get_current_live_price(symbol_code)\n                print(f\"\\n   üìä {symbol_name} (‚Çπ{current_price:.2f}):\")\n                \n                for i, zone in enumerate(zones[:3]):  # Top 3 zones\n                    distance = abs(current_price - zone.level) / current_price * 100 if current_price else 0\n                    proximity_indicator = \"üî•\" if distance <= 0.3 else \"üìç\" if distance <= 1.0 else \"üìå\"\n                    strength_indicator = \"üíé\" if zone.strength >= 4 else \"‚≠ê\"\n                    \n                    print(f\"      {proximity_indicator} {strength_indicator} {zone.zone_type.value}: ‚Çπ{zone.level:.2f} \")\n                    print(f\"         Strength: {zone.strength} | Success: {zone.success_rate:.1%} | Distance: {distance:.2f}%\")\n                    \n                    total_zones += 1\n                    if zone.strength >= 4:\n                        strong_zones += 1\n                    if distance <= 0.5:\n                        immediate_opportunities += 1\n            else:\n                print(f\"\\n   üìä {symbol_name}: No active zones detected\")\n        \n        # Zone summary\n        print(f\"\\nüìä ZONE SUMMARY:\")\n        print(f\"   Total Active Zones: {total_zones}\")\n        print(f\"   üíé Strong Zones: {strong_zones}\")\n        print(f\"   üî• Immediate Opportunities: {immediate_opportunities}\")\n        \n        # Active trades detail\n        if self.zone_trading.active_trades:\n            print(f\"\\nüéØ ACTIVE TRADES:\")\n            print(\"-\" * 40)\n            \n            for trade_id, trade in self.zone_trading.active_trades.items():\n                pnl_indicator = \"üí∞\" if trade.unrealized_pnl > 0 else \"üìâ\" if trade.unrealized_pnl < 0 else \"‚ûñ\"\n                zone_indicator = \"üíé\" if trade.enhanced_targets else \"‚≠ê\"\n                \n                print(f\"\\n   {pnl_indicator} {zone_indicator} {trade.symbol.split(':')[1]} {trade.signal.value}:\")\n                print(f\"      üìä Entry: ‚Çπ{trade.entry_price:.2f} | Current: ‚Çπ{trade.current_price:.2f}\")\n                print(f\"      üí∞ P&L: ‚Çπ{trade.unrealized_pnl:+.2f} | Qty: {trade.quantity}\")\n                print(f\"      üéØ Targets: ‚Çπ{trade.target_1:.2f} / ‚Çπ{trade.target_2:.2f} | SL: ‚Çπ{trade.stop_loss:.2f}\")\n                \n                if trade.zone_used:\n                    print(f\"      üíé Zone: {trade.zone_used.zone_type.value} @ ‚Çπ{trade.zone_used.level:.2f} (Strength: {trade.zone_strength})\")\n        else:\n            print(f\"\\n‚è∏Ô∏è No active trades - Scanning for zone opportunities...\")\n        \n        # Risk monitoring\n        print(f\"\\nüõ°Ô∏è RISK MONITORING:\")\n        print(\"-\" * 30)\n        risk_pct = abs(self.zone_trading.daily_pnl) / self.zone_trading.max_daily_loss * 100\n        risk_indicator = \"üü¢\" if risk_pct < 50 else \"üü°\" if risk_pct < 80 else \"üî¥\"\n        print(f\"   {risk_indicator} Daily Risk Used: {risk_pct:.1f}% (‚Çπ{abs(self.zone_trading.daily_pnl):.0f} / ‚Çπ{self.zone_trading.max_daily_loss:.0f})\")\n        \n        position_usage = len(self.zone_trading.active_trades) / self.zone_trading.max_positions * 100\n        pos_indicator = \"üü¢\" if position_usage < 70 else \"üü°\" if position_usage < 90 else \"üî¥\"\n        print(f\"   {pos_indicator} Position Usage: {position_usage:.1f}% ({len(self.zone_trading.active_trades)} / {self.zone_trading.max_positions})\")\n        \n        # Next update countdown\n        print(f\"\\n‚è∞ Next update in: {self.update_interval} seconds | Press Ctrl+C to stop\")\n        print(f\"=\"*80)\n    \n    def generate_trading_alerts(self):\n        \"\"\"Generate trading alerts based on zone analysis\"\"\"\n        \n        alerts = []\n        \n        try:\n            for symbol_name, symbol_code in self.zone_trading.trading_symbols.items():\n                current_price = self.zone_trading.get_current_live_price(symbol_code)\n                if not current_price:\n                    continue\n                \n                symbol_key = symbol_code.split(':')[1]\n                zones = self.zone_trading.active_zones.get(symbol_key, [])\n                \n                for zone in zones:\n                    distance = abs(current_price - zone.level) / current_price * 100\n                    \n                    # High-priority alerts for strong zones\n                    if distance <= 0.2 and zone.strength >= 4:\n                        alert_type = \"üî• STRONG ZONE ALERT\"\n                        if zone.zone_type in [ZoneType.SUPPLY, ZoneType.STRONG_SUPPLY]:\n                            action = \"SELL SETUP\"\n                        else:\n                            action = \"BUY SETUP\"\n                        \n                        alerts.append({\n                            'priority': 'HIGH',\n                            'symbol': symbol_name,\n                            'type': alert_type,\n                            'action': action,\n                            'price': current_price,\n                            'zone_level': zone.level,\n                            'zone_strength': zone.strength,\n                            'success_rate': zone.success_rate,\n                            'distance': distance\n                        })\n                    \n                    # Medium-priority alerts for approaching zones\n                    elif distance <= 0.5 and zone.strength >= 2:\n                        alert_type = \"‚ö° ZONE APPROACH\"\n                        alerts.append({\n                            'priority': 'MEDIUM',\n                            'symbol': symbol_name,\n                            'type': alert_type,\n                            'zone_level': zone.level,\n                            'zone_strength': zone.strength,\n                            'distance': distance\n                        })\n            \n            # Display alerts if any\n            if alerts:\n                print(f\"\\nüö® TRADING ALERTS:\")\n                print(\"-\" * 30)\n                \n                for alert in sorted(alerts, key=lambda x: x['priority'] == 'HIGH', reverse=True):\n                    if alert['priority'] == 'HIGH':\n                        print(f\"   {alert['type']}: {alert['symbol']}\")\n                        print(f\"      üéØ {alert['action']} near ‚Çπ{alert['zone_level']:.2f}\")\n                        print(f\"      üí™ Zone Strength: {alert['zone_strength']} | Success: {alert['success_rate']:.1%}\")\n                        print(f\"      üìç Distance: {alert['distance']:.2f}%\")\n                    else:\n                        print(f\"   {alert['type']}: {alert['symbol']} approaching ‚Çπ{alert['zone_level']:.2f} (Distance: {alert['distance']:.2f}%)\")\n        \n        except Exception as e:\n            print(f\"‚ùå Error generating alerts: {e}\")\n        \n        return alerts\n    \n    def dashboard_loop(self):\n        \"\"\"Main dashboard loop\"\"\"\n        \n        while self.is_dashboard_active:\n            try:\n                # Collect fresh data\n                self.collect_live_data()\n                \n                # Display dashboard\n                self.display_live_dashboard()\n                \n                # Generate and display alerts\n                self.generate_trading_alerts()\n                \n                # Wait for next update\n                time.sleep(self.update_interval)\n                \n            except Exception as e:\n                print(f\"‚ùå Error in dashboard loop: {e}\")\n                time.sleep(10)  # Brief pause before retrying\n    \n    def start_dashboard(self):\n        \"\"\"Start the live trading dashboard\"\"\"\n        \n        print(f\"üíé STARTING ZONE TRADING DASHBOARD\")\n        print(f\"üéØ Live monitoring and analysis\")\n        print(f\"‚è∞ Update frequency: {self.update_interval} seconds\")\n        \n        self.is_dashboard_active = True\n        \n        # Start dashboard thread\n        self.dashboard_thread = threading.Thread(target=self.dashboard_loop, daemon=True)\n        self.dashboard_thread.start()\n        \n        print(f\"‚úÖ Dashboard active! Press Ctrl+C to stop\")\n        \n        try:\n            while self.is_dashboard_active:\n                time.sleep(1)\n        except KeyboardInterrupt:\n            print(f\"\\nüõë Stopping dashboard...\")\n            self.stop_dashboard()\n    \n    def stop_dashboard(self):\n        \"\"\"Stop the dashboard\"\"\"\n        \n        self.is_dashboard_active = False\n        if self.dashboard_thread and self.dashboard_thread.is_alive():\n            self.dashboard_thread.join(timeout=2)\n        \n        print(f\"‚úÖ Dashboard stopped\")\n    \n    def export_performance_report(self):\n        \"\"\"Export detailed performance report\"\"\"\n        \n        try:\n            report_data = {\n                'timestamp': datetime.now().isoformat(),\n                'daily_pnl': self.zone_trading.daily_pnl,\n                'total_trades': self.zone_trading.total_trades_today,\n                'zone_trades': self.zone_trading.zone_trade_count,\n                'active_positions': len(self.zone_trading.active_trades),\n                'active_trades': [],\n                'active_zones': {}\n            }\n            \n            # Export active trades\n            for trade_id, trade in self.zone_trading.active_trades.items():\n                trade_data = {\n                    'trade_id': trade_id,\n                    'symbol': trade.symbol,\n                    'signal': trade.signal.value,\n                    'entry_price': trade.entry_price,\n                    'current_price': trade.current_price,\n                    'unrealized_pnl': trade.unrealized_pnl,\n                    'zone_strength': trade.zone_strength,\n                    'enhanced_targets': trade.enhanced_targets\n                }\n                report_data['active_trades'].append(trade_data)\n            \n            # Export active zones\n            for symbol_key, zones in self.zone_trading.active_zones.items():\n                report_data['active_zones'][symbol_key] = [\n                    {\n                        'type': zone.zone_type.value,\n                        'level': zone.level,\n                        'strength': zone.strength,\n                        'success_rate': zone.success_rate\n                    } for zone in zones\n                ]\n            \n            # Save report\n            filename = f\"zone_trading_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json\"\n            with open(filename, 'w') as f:\n                json.dump(report_data, f, indent=2)\n            \n            print(f\"üìä Performance report exported: {filename}\")\n            return filename\n            \n        except Exception as e:\n            print(f\"‚ùå Error exporting report: {e}\")\n            return None\n    \n    def run_zone_analysis(self):\n        \"\"\"Run comprehensive zone analysis\"\"\"\n        \n        print(f\"üíé Running zone analysis...\")\n        try:\n            # Run analysis for both symbols\n            results = self.zone_analyzer.run_complete_analysis()\n            print(f\"‚úÖ Zone analysis complete\")\n            return results\n        except Exception as e:\n            print(f\"‚ùå Error running zone analysis: {e}\")\n            return None\n\ndef main():\n    \"\"\"Main function for zone trading dashboard\"\"\"\n    \n    print(f\"üíé SUPPLY/DEMAND ZONE TRADING DASHBOARD\")\n    print(f\"üéØ Live monitoring, analysis, and trading\")\n    print(f\"=\"*60)\n    \n    try:\n        dashboard = ZoneTradingDashboard()\n        \n        print(f\"\\nüìä Dashboard Options:\")\n        print(f\"   1. Start live trading dashboard\")\n        print(f\"   2. Run zone analysis only\")\n        print(f\"   3. Export performance report\")\n        print(f\"   4. Full zone analysis + dashboard\")\n        \n        choice = input(f\"\\nüéØ Choose option (1/2/3/4): \")\n        \n        if choice == '1':\n            print(f\"\\nüíé Starting live trading dashboard...\")\n            dashboard.start_dashboard()\n            \n        elif choice == '2':\n            print(f\"\\nüìä Running zone analysis...\")\n            dashboard.run_zone_analysis()\n            \n        elif choice == '3':\n            print(f\"\\nüìÑ Exporting performance report...\")\n            dashboard.export_performance_report()\n            \n        elif choice == '4':\n            print(f\"\\nüíé Running full analysis and starting dashboard...\")\n            dashboard.run_zone_analysis()\n            time.sleep(3)  # Brief pause\n            dashboard.start_dashboard()\n            \n        else:\n            print(f\"‚ùå Invalid choice\")\n            return\n        \n        print(f\"\\n‚úÖ Dashboard session completed!\")\n        \n    except Exception as e:\n        print(f\"‚ùå Error in dashboard: {e}\")\n        import traceback\n        traceback.print_exc()\n\nif __name__ == \"__main__\":\n    main()